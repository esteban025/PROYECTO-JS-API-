---
import Card from "@/components/Card.astro";

// Obtener el n칰mero de p치gina desde la URL
const currentPage = Astro.url.searchParams.get("page") || "1";

// Obtener datos de la ruta API con el par치metro de p치gina
const res = await fetch(
  new URL(`/api/get-info-filter?page=${currentPage}`, Astro.url.origin),
);
const infoFilter = await res.json();
const charactesPage = infoFilter.characters;
---

<section class="w-full max-w-5xl mx-auto p-4">
  <h2 class="text-3xl font-bold mb-6 text-white">Personajes</h2>
  <div id="no-results" class="hidden text-center text-text-secondary py-8">
    <p class="text-lg">No se encontraron personajes con ese nombre 游땟</p>
  </div>
  <section
    id="characters-grid"
    class="grid gap-4"
    style="grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));"
  >
    {charactesPage.map((character: any) => <Card personage={character} />)}
  </section>
</section>

<script>
  document.addEventListener("astro:page-load", () => {
    const $charactersGrid = document.getElementById("characters-grid");
    const $noResults = document.getElementById("no-results");
    const FILTERS_KEY = "rickmorty-filters";

    // Cargar filtros desde localStorage
    function loadFilters() {
      const stored = localStorage.getItem(FILTERS_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return { search: "", status: "all", species: "all" };
        }
      }
      return { search: "", status: "all", species: "all" };
    }

    // Aplicar filtros a las cards
    function applyFiltersFromStorage() {
      const currentFilters = loadFilters();
      const cards = $charactersGrid?.querySelectorAll("article");
      let visibleCount = 0;

      cards?.forEach((card) => {
        const nameElement = card.querySelector("h3");
        const statusElement = card.querySelector("p.text-text-secondary");
        const speciesElement = card.querySelector("p.text-primary");

        const characterName =
          nameElement?.textContent?.toLowerCase().trim() || "";
        const characterStatus =
          statusElement?.textContent
            ?.toLowerCase()
            .replace("estado:", "")
            .trim() || "";
        const characterSpecies =
          speciesElement?.textContent?.toLowerCase().trim() || "";

        // Verificar cada filtro
        const matchesSearch =
          currentFilters.search === "" ||
          characterName.includes(currentFilters.search.toLowerCase());
        const matchesStatus =
          currentFilters.status === "all" ||
          characterStatus === currentFilters.status;
        const matchesSpecies =
          currentFilters.species === "all" ||
          characterSpecies === currentFilters.species;

        // Mostrar solo si cumple todos los filtros
        if (matchesSearch && matchesStatus && matchesSpecies) {
          card.classList.remove("hidden");
          visibleCount++;
        } else {
          card.classList.add("hidden");
        }
      });

      // Mostrar mensaje si no hay resultados
      if (visibleCount === 0) {
        $noResults?.classList.remove("hidden");
        $charactersGrid?.classList.add("hidden");
      } else {
        $noResults?.classList.add("hidden");
        $charactersGrid?.classList.remove("hidden");
      }
    }

    // Escuchar evento personalizado para cambios en la misma pesta침a
    document.addEventListener("filters-updated", applyFiltersFromStorage);

    // Aplicar filtros al cargar la p치gina
    applyFiltersFromStorage();
  });
</script>
