---
import Card from "@/components/Card.astro";

// Obtener el n√∫mero de p√°gina desde la URL
const currentPage = Astro.url.searchParams.get("page") || "1";

// Obtener datos de la ruta API con el par√°metro de p√°gina
const res = await fetch(
  new URL(`/api/get-info-filter?page=${currentPage}`, Astro.url.origin),
);
const infoFilter = await res.json();
const charactesPage = infoFilter.characters;
---

<section class="w-full max-w-5xl mx-auto p-4">
  <h2 class="text-3xl font-bold mb-6 text-white">Personajes</h2>
  <div id="no-results" class="hidden text-center text-text-secondary py-8">
    <p class="text-lg">No se encontraron personajes üòï</p>
  </div>
  <div id="no-favorites" class="hidden text-center text-text-secondary py-8">
    <p class="text-lg">No tienes personajes favoritos a√∫n ‚≠ê</p>
    <p class="text-sm mt-2">
      Haz clic en la estrella de cualquier personaje para agregarlo a favoritos
    </p>
  </div>
  <section
    id="characters-grid"
    class="grid gap-4"
    style="grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));"
  >
    {charactesPage.map((character: any) => <Card personage={character} />)}
  </section>
</section>

<script>
  document.addEventListener("astro:page-load", () => {
    const $charactersGrid = document.getElementById("characters-grid");
    const $noResults = document.getElementById("no-results");
    const $noFavorites = document.getElementById("no-favorites");
    const FILTERS_KEY = "rickmorty-filters";
    const FAVORITES_KEY = "rickmorty-favorites";

    // Cargar filtros desde localStorage
    function loadFilters() {
      const stored = localStorage.getItem(FILTERS_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return {
            search: "",
            status: "all",
            species: "all",
            onlyFavorites: false,
          };
        }
      }
      return {
        search: "",
        status: "all",
        species: "all",
        onlyFavorites: false,
      };
    }

    // Obtener favoritos desde localStorage
    function getFavorites(): number[] {
      const stored = localStorage.getItem(FAVORITES_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return [];
        }
      }
      return [];
    }

    // Aplicar filtros a las cards
    function applyFiltersFromStorage() {
      const currentFilters = loadFilters();
      const favorites = getFavorites();
      const cards = $charactersGrid?.querySelectorAll("article");
      let visibleCount = 0;

      cards?.forEach((card) => {
        const characterId = parseInt(
          card.getAttribute("data-character-id") || "0",
        );
        const nameElement = card.querySelector("h3");
        const statusElement = card.querySelector("p.text-text-secondary");
        const speciesElement = card.querySelector("p.text-primary");

        const characterName =
          nameElement?.textContent?.toLowerCase().trim() || "";
        const characterStatus =
          statusElement?.textContent
            ?.toLowerCase()
            .replace("estado:", "")
            .trim() || "";
        const characterSpecies =
          speciesElement?.textContent?.toLowerCase().trim() || "";

        // Verificar cada filtro
        const matchesSearch =
          currentFilters.search === "" ||
          characterName.includes(currentFilters.search.toLowerCase());
        const matchesStatus =
          currentFilters.status === "all" ||
          characterStatus === currentFilters.status;
        const matchesSpecies =
          currentFilters.species === "all" ||
          characterSpecies === currentFilters.species;
        const matchesFavorites =
          !currentFilters.onlyFavorites || favorites.includes(characterId);

        // Mostrar solo si cumple todos los filtros
        if (
          matchesSearch &&
          matchesStatus &&
          matchesSpecies &&
          matchesFavorites
        ) {
          card.classList.remove("hidden");
          visibleCount++;
        } else {
          card.classList.add("hidden");
        }
      });

      // Mostrar mensaje apropiado si no hay resultados
      if (visibleCount === 0) {
        $charactersGrid?.classList.add("hidden");

        if (currentFilters.onlyFavorites && favorites.length === 0) {
          // No tiene favoritos
          $noFavorites?.classList.remove("hidden");
          $noResults?.classList.add("hidden");
        } else {
          // Tiene filtros activos pero no hay resultados
          $noResults?.classList.remove("hidden");
          $noFavorites?.classList.add("hidden");
        }
      } else {
        $noResults?.classList.add("hidden");
        $noFavorites?.classList.add("hidden");
        $charactersGrid?.classList.remove("hidden");
      }
    }

    // Escuchar evento personalizado para cambios en la misma pesta√±a
    document.addEventListener("filters-updated", applyFiltersFromStorage);

    // Aplicar filtros al cargar la p√°gina
    applyFiltersFromStorage();
  });
</script>
