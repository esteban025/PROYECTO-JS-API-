---
import Card from "@/components/Card.astro";

// Obtener el n칰mero de p치gina desde la URL
const currentPage = Astro.url.searchParams.get("page") || "1";

// Obtener datos de la ruta API con el par치metro de p치gina
const res = await fetch(
  new URL(`/api/get-info-filter?page=${currentPage}`, Astro.url.origin),
);
const infoFilter = await res.json();
const charactesPage = infoFilter.characters;
---

<section class="w-full max-w-5xl mx-auto p-4">
  <h2 class="text-3xl font-bold mb-6 text-white">Personajes</h2>
  <div id="no-results" class="hidden text-center text-text-secondary py-8">
    <p class="text-lg">No se encontraron personajes con ese nombre 游땟</p>
  </div>
  <section
    id="characters-grid"
    class="grid gap-4"
    style="grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));"
  >
    {charactesPage.map((character: any) => <Card personage={character} />)}
  </section>
</section>

<script>
  document.addEventListener("astro:page-load", () => {
    const $charactersGrid = document.getElementById("characters-grid");
    const $noResults = document.getElementById("no-results");
    const $searchInput = document.getElementById(
      "search-input",
    ) as HTMLInputElement;
    const $statusButtons = document.querySelectorAll('[data-filter="status"]');
    const $speciesSelect = document.getElementById(
      "species-filter",
    ) as HTMLSelectElement;
    const $clearButton = document.getElementById("clear-filters");

    const FILTERS_KEY = "rickmorty-filters";

    // Cargar filtros desde localStorage
    const loadFilters = () => {
      const stored = localStorage.getItem(FILTERS_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return { search: "", status: "all", species: "all" };
        }
      }
      return { search: "", status: "all", species: "all" };
    };

    // Guardar filtros en localStorage
    const saveFilters = (filters: any) => {
      localStorage.setItem(FILTERS_KEY, JSON.stringify(filters));
    };

    let currentFilters = loadFilters();

    // Aplicar filtros guardados a los controles
    const applyStoredFiltersToControls = () => {
      // Aplicar b칰squeda
      if ($searchInput && currentFilters.search) {
        $searchInput.value = currentFilters.search;
      }

      // Aplicar estado - validar si existe en las opciones actuales
      const availableStatuses = Array.from($statusButtons).map((btn) =>
        btn.getAttribute("data-value"),
      );
      if (availableStatuses.includes(currentFilters.status)) {
        $statusButtons.forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === currentFilters.status) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
      } else {
        // Si el estado guardado no existe en esta p치gina, resetear a "all"
        currentFilters.status = "all";
        $statusButtons.forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === "all") {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
        saveFilters(currentFilters);
      }

      // Aplicar especie - validar si existe en las opciones actuales
      if ($speciesSelect) {
        const options = Array.from($speciesSelect.options).map(
          (opt) => opt.value,
        );
        if (options.includes(currentFilters.species)) {
          $speciesSelect.value = currentFilters.species;
        } else {
          // Si la especie guardada no existe en esta p치gina, resetear a "all"
          currentFilters.species = "all";
          $speciesSelect.value = "all";
          saveFilters(currentFilters);
        }
      }
    };

    const applyFilters = () => {
      const cards = $charactersGrid?.querySelectorAll("article");
      let visibleCount = 0;

      cards?.forEach((card) => {
        const link = card.querySelector("a");
        const nameElement = card.querySelector("h3");
        const statusElement = card.querySelector("p.text-text-secondary");
        const speciesElement = card.querySelector("p.text-primary");

        const characterName =
          nameElement?.textContent?.toLowerCase().trim() || "";
        const characterStatus =
          statusElement?.textContent
            ?.toLowerCase()
            .replace("estado:", "")
            .trim() || "";
        const characterSpecies =
          speciesElement?.textContent?.toLowerCase().trim() || "";

        // Verificar cada filtro
        const matchesSearch =
          currentFilters.search === "" ||
          characterName.includes(currentFilters.search.toLowerCase());
        const matchesStatus =
          currentFilters.status === "all" ||
          characterStatus === currentFilters.status;
        const matchesSpecies =
          currentFilters.species === "all" ||
          characterSpecies === currentFilters.species;

        // Mostrar solo si cumple todos los filtros
        if (matchesSearch && matchesStatus && matchesSpecies) {
          card.classList.remove("hidden");
          visibleCount++;
        } else {
          card.classList.add("hidden");
        }
      });

      // Mostrar mensaje si no hay resultados
      if (visibleCount === 0) {
        $noResults?.classList.remove("hidden");
        $charactersGrid?.classList.add("hidden");
      } else {
        $noResults?.classList.add("hidden");
        $charactersGrid?.classList.remove("hidden");
      }

      // Guardar filtros
      saveFilters(currentFilters);
    };

    // Filtro por b칰squeda
    $searchInput?.addEventListener("input", (e) => {
      currentFilters.search = (e.target as HTMLInputElement).value;
      applyFilters();
    });

    // Filtro por estado
    $statusButtons.forEach((button) => {
      button.addEventListener("click", () => {
        $statusButtons.forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        currentFilters.status = button.getAttribute("data-value") || "all";
        applyFilters();
      });
    });

    // Filtro por especie
    $speciesSelect?.addEventListener("change", (e) => {
      currentFilters.species = (e.target as HTMLSelectElement).value;
      applyFilters();
    });

    // Limpiar filtros
    $clearButton?.addEventListener("click", () => {
      if ($searchInput) $searchInput.value = "";
      if ($speciesSelect) $speciesSelect.value = "all";

      $statusButtons.forEach((btn) => btn.classList.remove("active"));
      const allButton = document.querySelector(
        '[data-filter="status"][data-value="all"]',
      );
      allButton?.classList.add("active");

      currentFilters = {
        search: "",
        status: "all",
        species: "all",
      };

      saveFilters(currentFilters);
      applyFilters();
    });

    // Inicializar: aplicar filtros guardados y luego filtrar
    applyStoredFiltersToControls();
    applyFilters();
  });
</script>
