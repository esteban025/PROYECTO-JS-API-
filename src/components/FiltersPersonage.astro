---
import ButtonPrimary from "@components/ButtonPrimary.astro";
import ButtonFilter from "@components/ButtonFilter.astro";
import SearchPersonage from "./SearchPersonage.astro";

import FilterIcon from "@assets/filter-icon.svg";
import RefreshIcon from "@assets/refresh.svg";

import ArrowDownIcon from "@assets/arrow-down.svg";

// Obtener el número de página desde la URL
const currentPage = Astro.url.searchParams.get("page") || "1";

const response = await fetch(
  new URL(`/api/get-info-filter?page=${currentPage}`, Astro.url.origin),
);
const infoFilter = await response.json();
const speciesOptions = infoFilter.species;
const statusOptions = infoFilter.status;
---

<article class="w-full max-w-4xl mx-auto p-4">
  <div class="flex flex-col gap-6">
    <header class="flex items-center justify-between">
      <h2 class="text-xl font-bold mb-4 text-white flex items-center gap-2">
        <FilterIcon class="w-5 h-5 text-primary" />
        Filtros
      </h2>
      <ButtonPrimary id="clear-filters">
        <RefreshIcon class="w-4 h-4" />
        Limpiar Filtros
      </ButtonPrimary>
    </header>

    <div
      class="grid gap-3 grid-container-filters"
      style="grid-template-columns: repeat(auto-fit, minmax(min(100%, 200px), 1fr));"
    >
      <!-- Filtro de busqueda -->
      <SearchPersonage />

      <!-- Filtro por Especie -->
      <div class="w-full">
        <div
          id="species-wrapper"
          class="relative group px-3 py-2 rounded-lg border-2 bg-bg-card/50 border-primary/20 text-white focus:outline-none focus:border-primary focus:shadow-md-primary hover:bg-bg-card/95 hover:border-primary/40 transition-all duration-200 appearance-none cursor-pointer text-sm"
        >
          <select id="species-filter" class="select-custom w-full">
            <option
              value="all"
              class="bg-bg-card text-text-primary p-3 rounded-lg font-medium transition-all option-custom options"
              >Todas las especies</option
            >
            {
              speciesOptions.map((specie: any) => (
                <option
                  value={specie.toLowerCase()}
                  class="text-text-primary p-3 rounded-lg font-medium transition-all option-custom hover:bg-option-hover-bg bg-bg-card options"
                >
                  {specie}
                </option>
              ))
            }
          </select>
          <ArrowDownIcon
            class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 transition-transform duration-200 text-primary pointer-events-none group-focus-within:rotate-180"
          />
        </div>
      </div>

      <!-- Filtro por Estado -->
      <div
        class="w-full rounded-lg p-1 bg-bg-card/50 min-h-11 border-2 border-primary/20"
      >
        <div class="flex items-center gap-1 w-full h-full relative">
          <div
            id="selector-block"
            class="absolute bg-primary h-full rounded-lg transition-all duration-300 pointer-events-none"
          >
          </div>
          <ButtonFilter text="Todos" value="all" filter="status" />
          {
            statusOptions.map((status: any) => (
              <ButtonFilter
                text={status.charAt(0).toUpperCase() + status.slice(1)}
                value={status.toLowerCase()}
                filter="status"
              />
            ))
          }
        </div>
      </div>
    </div>
  </div>
</article>

<script>
  document.addEventListener("astro:page-load", () => {
    const $statusButtons = document.querySelectorAll('[data-filter="status"]');
    const $selectorBlock = document.getElementById("selector-block");
    const $clearButton = document.getElementById("clear-filters");
    const $searchInput = document.getElementById(
      "search-input",
    ) as HTMLInputElement;
    const $speciesSelect = document.getElementById(
      "species-filter",
    ) as HTMLSelectElement;

    const FILTERS_KEY = "rickmorty-filters";

    // Cargar filtros desde localStorage
    const loadFilters = () => {
      const stored = localStorage.getItem(FILTERS_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return { search: "", status: "all", species: "all" };
        }
      }
      return { search: "", status: "all", species: "all" };
    };

    // Guardar filtros en localStorage y notificar cambio
    const saveFilters = (filters: any) => {
      localStorage.setItem(FILTERS_KEY, JSON.stringify(filters));
      // Disparar evento personalizado para notificar cambio
      document.dispatchEvent(new CustomEvent("filters-updated"));
    };

    let currentFilters = loadFilters();

    if ($selectorBlock && $statusButtons.length > 0) {
      // Función para mover el selector al botón activo
      const moveSelector = (button: Element) => {
        const buttonElement = button as HTMLElement;
        const containerRect =
          buttonElement.parentElement!.getBoundingClientRect();
        const buttonRect = buttonElement.getBoundingClientRect();

        const offsetLeft = buttonRect.left - containerRect.left;
        const width = buttonRect.width;

        $selectorBlock.style.width = `${width}px`;
        $selectorBlock.style.transform = `translateX(${offsetLeft}px)`;
      };

      // Event listeners para cada botón de status
      $statusButtons.forEach((button) => {
        button.addEventListener("click", () => {
          $statusButtons.forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          // Actualizar filtros
          currentFilters.status = button.getAttribute("data-value") || "all";
          saveFilters(currentFilters);

          // Mover selector visual
          moveSelector(button);
        });
      });

      // Event listener para el input de búsqueda
      $searchInput?.addEventListener("input", (e) => {
        currentFilters.search = (e.target as HTMLInputElement).value;
        saveFilters(currentFilters);
      });

      // Event listener para el select de especies
      $speciesSelect?.addEventListener("change", (e) => {
        currentFilters.species = (e.target as HTMLSelectElement).value;
        saveFilters(currentFilters);
      });

      // Event listener para el botón de limpiar filtros
      $clearButton?.addEventListener("click", () => {
        // Resetear valores en la UI
        if ($searchInput) $searchInput.value = "";
        if ($speciesSelect) $speciesSelect.value = "all";

        $statusButtons.forEach((btn) => btn.classList.remove("active"));

        // Agregar active al botón "all"
        const allButton = document.querySelector(
          '[data-filter="status"][data-value="all"]',
        );
        allButton?.classList.add("active");

        // Resetear filtros
        currentFilters = {
          search: "",
          status: "all",
          species: "all",
        };
        saveFilters(currentFilters);

        // Mover selector al botón "all"
        if (allButton) moveSelector(allButton);
      });

      // INICIALIZACIÓN: Aplicar filtros guardados a la UI
      // Aplicar búsqueda
      if ($searchInput && currentFilters.search) {
        $searchInput.value = currentFilters.search;
      }

      // Aplicar especie
      if ($speciesSelect && currentFilters.species) {
        const options = Array.from($speciesSelect.options).map(
          (opt) => opt.value,
        );
        if (options.includes(currentFilters.species)) {
          $speciesSelect.value = currentFilters.species;
        } else {
          // Si la especie guardada no existe, resetear
          currentFilters.species = "all";
          $speciesSelect.value = "all";
          saveFilters(currentFilters);
        }
      }

      // Aplicar status y posicionar selector
      const availableStatuses = Array.from($statusButtons).map((btn) =>
        btn.getAttribute("data-value"),
      );

      if (availableStatuses.includes(currentFilters.status)) {
        // El status guardado existe en esta página
        $statusButtons.forEach((btn) => {
          const value = btn.getAttribute("data-value");
          if (value === currentFilters.status) {
            btn.classList.add("active");
            moveSelector(btn);
          } else {
            btn.classList.remove("active");
          }
        });
      } else {
        // El status guardado no existe, resetear a "all"
        currentFilters.status = "all";
        saveFilters(currentFilters);

        const allButton = document.querySelector(
          '[data-filter="status"][data-value="all"]',
        );
        if (allButton) {
          allButton.classList.add("active");
          moveSelector(allButton);
        }
      }

      // Notificar que los filtros están listos después de la inicialización
      document.dispatchEvent(new CustomEvent("filters-updated"));
    }
  });
</script>

<style>
  select,
  ::picker(select) {
    appearance: base-select;
  }

  ::picker(select) {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: var(--color-gradient-select);
    border-radius: 1rem;
    margin-bottom: 0.5rem;
  }
  ::picker-icon {
    display: none;
  }

  .option-custom:checked,
  .option-custom:focus {
    background-color: var(--color-option-selected-bg);
    color: var(--color-primary);
    font-weight: 600;
  }
  .options ~ .options {
    margin-top: 3px;
  }
  .grid-container-filters > *:last-child:nth-child(odd) {
    grid-column: span 2;
  }

  #species-wrapper:has(select option[value="all"]:not(:checked)) {
    border-color: var(--color-primary);
  }
</style>
